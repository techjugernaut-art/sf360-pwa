<app-main-nav [isProcessing]="isProcessing">
  <app-breadcrumb-actions class="full-width" [pageHeaderOptions]="pageHeaderOptions"
    (dataRefreshed)="onDataRefreshed($event)">
    <div mainAction>
      <button mat-raised-button  color="accent"  (click)="onNewSale()">
        NEW SALE
      </button>
    </div>
  </app-breadcrumb-actions>

  <mat-card>
      <mat-card-header class="card-header-full-width mb-3">
          <mat-card-title>
            <b>Total Sales: {{salesOrdersReports?.total_sales}}</b>
          </mat-card-title>

        </mat-card-header>
    <mat-card-content class="ml-3 mr-3">
      <app-table-header-actions [tableHeaderOptions]="tableHeaderOption" (searchTextChanged)="onSearchOrder($event)">

        <button mat-button mat-stroked-button color="primary" type="button" [matMenuTriggerFor]="mainActionsMenu" ><i class="fe fe-download mr-1"></i> EXPORT AS</button>
        <mat-menu #mainActionsMenu="matMenu">
        <button mat-menu-item (click)="exportAsExcel()">EXCEL</button>
        <button mat-menu-item (click)="exportAllAPDF()">PDF</button>
        </mat-menu>
      </app-table-header-actions>
      <div class="table-responsive">
       <!-- <app-sales-order-list-item [salesOrders]="salesOrders"></app-sales-order-list-item> -->
       <table class="table dataTable no-footer table-border-bottom">
        <thead>
          <tr>
            <th class="wd-15p">Order #</th>
            <th class="wd-15p">Customer</th>
            <th class="wd-15p">Amount</th>
            <th class="wd-15p">Payment Method</th>
            <th class="wd-10p">Shop</th>
            <th class="wd-25p">Date Placed</th>
            <th class="wd-25p">Actions</th>

          </tr>
        </thead>
        <tbody *ngIf="salesOrders?.length <= 0">
          <tr>
            <td colspan="10" class="text-center"><app-empty-record></app-empty-record></td>
        </tr>
        </tbody>
        <tbody  *ngFor="let order of salesOrders" [class.bg-collapsed-table]="order?.id == orderId">

          <tr>
            <td class="cursor-pointer text-primary" (click)="collapseOrderDetail(order)"> {{order?.order_code}}</td>
            <td>{{order?.customer?.phone_number}} <span
                *ngIf="order?.customer?.phone_number !== '' && order?.customer?.phone_number !== null && order?.customer?.name !== '' && order?.customer?.name !== null">/</span>
              {{order?.customer?.name}}</td>
            <td>{{order?.currency}} {{order?.total_amount | number: '1.2-2'}}</td>
            <td>{{order?.payment_method}}</td>
            <td>{{order?.myshop?.business_name | titlecase}}</td>
            <td>{{order?.date_placed | date: 'medium'}}</td>
            <td class="text-center">

              <button class="btn btn-primary btn-sm" (click)="viewOrderDetails(order)" data-toggle="modal"
                data-target="#modalSalesOrdersDetail">
                <i class="fe fe-eye"></i>
              </button>
            </td>
          </tr>
          <tr [@inOutAnimation]="order?.id == orderId ? 'expanded' : 'collapsed'">
            <td colspan="20">
              <table class="table no-footer table-border-bottom" >
                  <thead>
                      <tr>
                        <th class="wd-15p">Product Name</th>
                        <th class="wd-15p">SUPPLIER PRICE</th>
                        <th class="wd-15p">SELLING PRICE</th>
                        <th class="wd-15p">QTY BEFORE</th>
                        <th class="wd-15p">QTY SOLD</th>
                        <th class="wd-15p">QTY AFTER</th>
                        <th class="wd-15p">SUBTOTAL</th>

                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of order?.myitems" >
                        <td>{{item?.my_product?.name}}</td>
                        <td>{{item?.my_product?.supplier_price}}</td>
                        <td>{{item?.product_price}}</td>
                        <td>
                          <span *ngIf="!item?.my_product?.is_service">{{item?.product_quantity_before}}</span>
                          <span *ngIf="item?.my_product?.is_service">N/A</span>
                        </td>
                        <td>{{item?.new_quantity}}</td>
                        <td>
                            <span *ngIf="!item?.my_product?.is_service">{{item?.product_quantity_after}}</span>
                            <span *ngIf="item?.my_product?.is_service">N/A</span>
                          </td>
                          <td>{{item?.subtotal}}</td>
                      </tr>
                    </tbody>
              </table>
            </td>
          </tr>
        </tbody>
      </table>




    </div>
      <app-pagination [dataSet]="salesOrders" [nextPage]="nextPage" [prevPage]="prevPage" [totalPage]="totalPage"
        [requestPayload]="requestPayload" [requestMethod]="'POST'" (pageChanged)="onPageChanged($event)"
        [isProcessing]="isProcessing"></app-pagination>

    </mat-card-content>
  </mat-card>




</app-main-nav>


      <!-- Sales Orders Details Modal -->
      <div class="modal fade" id="modalSalesOrdersDetail" tabindex="-1" role="dialog" aria-labelledby="modal-notification"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title invoice-modal-title" id="modal-title-notification">
                Order #: {{saleOrderDetail?.order_code}}
              </h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">Ã—</span>
              </button>
            </div>
            <div class="modal-body" id="salesOrderModalBody">
              <div class="logo-img text-center pb-3">
                <img src="../assets/img/logos/dark-green.png" alt="invoice-logo-img" class="invoice-logo-img">
              </div>
              <div class="mb-0">
                <div class="row">
                  <div class="col-6 invoice-detail">
                    <h4 class="title"><strong>Order #: {{saleOrderDetail?.order_code}}</strong></h4>
                    <p class="mb-0 detail"><strong>{{saleOrderDetail?.myshop?.business_name | titlecase}}</strong></p>
                    <p class="mb-0 detail">{{saleOrderDetail?.myshop?.location | titlecase}}</p>
                    <p class="mb-0 detail">Date Placed: {{saleOrderDetail?.date_placed | date: 'MM/dd/yyyy, HH:mm:ss'}}</p>
                    <p class="mb-0 detail">Payment Method: {{saleOrderDetail?.payment_method}}</p>

                  </div>
                  <div class="col-6 text-right invoice-detail">
                    <h4 class="title"><strong>Customer Info: </strong></h4>
                    <p class="mb-0 detail"><strong>{{saleOrderDetail?.customer?.name | titlecase}}</strong></p>
                    <p class="mb-0 detail">Phone: {{saleOrderDetail?.customer?.phone_number}}</p>
                    <p class="mb-0 detail">Email: {{saleOrderDetail?.customer?.email}}</p>
                    <p class="mb-0 detail">Address: {{saleOrderDetail?.customer?.address}}</p>

                  </div>

                </div>
                <!-- end row -->

                <div class="row mt-4">
                  <div class="col-md-12">
                    <div class="table-responsive">
                      <table class="table m-t-30 text-nowrap  table-border-bottom invoice-table">
                        <thead class="thead-primary">
                          <tr>
                            <th>#</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th class="text-right">Selling Price ({{saleOrderDetail?.currency}})</th>
                            <th class="text-right">Amount ({{saleOrderDetail?.currency}})</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of salesOrderItems">
                            <td>{{item?.id}}</td>
                            <td>{{item?.my_product?.name}}</td>
                            <td>{{item?.new_quantity}}</td>
                            <td class="text-right">{{item?.my_product?.selling_price | number: '1.2-2'}}</td>
                            <td class="text-right">{{item?.subtotal | number: '1.2-2'}}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xl-4 col-12 offset-xl-8 invoice-footer">
                    <p class="text-right mt-3 fs-15 font-weight-600">Sub-total: {{saleOrderDetail?.currency}}
                      {{saleOrderDetail?.gross_total | number: '1.2-2'}}</p>
                    <p class="text-right font-weight-600 fs-15">Discout: {{saleOrderDetail?.discount}}</p>
                    <p class="text-right font-weight-600 fs-15">VAT: {{saleOrderDetail?.vat_value}}</p>
                    <hr>
                    <h4 class="text-right grand-total">Grand Total : {{saleOrderDetail?.currency}}
                      {{saleOrderDetail?.total_amount | number: '1.2-2'}}</h4>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12 invoice-detail">
                    <h4 class="title"><strong>Agent</strong></h4>
                    <p class="mb-0 detail"><strong>{{saleOrderDetail?.author?.first_name | titlecase}},
                        {{saleOrderDetail?.author?.last_name | titlecase}}</strong></p>
                    <p class="mb-0 detail">Phone: {{saleOrderDetail?.author?.phone_number}}</p>
                    <p class="mb-0 detail">Email: {{saleOrderDetail?.author?.email}}</p>
                  </div>
                  <div class="col-12" *ngIf="saleOrderDetail?.cancel_reason !== null && saleOrderDetail?.cancel_reason !== ''">
                    <div class="alert alert-danger" role="alert">
                      CANCELLATION REASON: {{saleOrderDetail?.cancel_reason}}
                    </div>
                  </div>
                </div>

              </div>
            </div>
            <div class="modal-footer">
              <button mat-raised-button color="primary" (click)="exportAsPDF()"><i class="fa fa-file-pdf"></i> Download As PDF</button>
            </div>
          </div>
        </div>
      </div>
      <!-- End of Sales Orders Details Modal -->
