<app-main-nav [isProcessing]="isProcessing">
    <div class="row">
        <div class="col-9">
            <h3 class="my-4">{{modalTitle}}</h3>
        </div>
    </div>
  <div class="row " style="display: flex; justify-content: center; overflow-y: auto;">
    <div class="col-xl-8 col-lg-8 col-md-9 col-12 bg-white pt-4">
        <div class="">
            <form [formGroup]="formGroup" (ngSubmit)="onSubmit(formGroup?.value)">
                <mat-horizontal-stepper #stepper>

                  <mat-step label="Setup">
                    <div class="row my-4">
                      <mat-form-field class="col-md-12">
                        <mat-label>Select Shop</mat-label>
                        <mat-select formControlName="shop_id" (selectionChange)="onShopChanged($event?.value)">
                          <mat-option *ngFor="let item of myShops" [value]="item?.id">{{item?.business_name}}</mat-option>
                        </mat-select>
                        <mat-hint class="text-danger" *ngIf="!shop_id?.valid && shop_id?.touched">Please select Shop</mat-hint>
                      </mat-form-field>
                    </div>
                    <mat-button-toggle-group formControlName="campaign_type" style="display: flex; justify-content: space-between; border: none !important;">
                      <div class="mat-button-toggle-center">
                        <mat-button-toggle color="ascent" class="square-toggle-button" [value]="campaignTypes?.ALL">
                            <span>
                                <img class="small-svg" src="assets/img/icons/megaphone-primary.svg" alt="">
                              </span> <br>
                          ALL
                        </mat-button-toggle>
                      </div>
                      <div class="mat-button-toggle-center">
                        <mat-button-toggle  color="primary" class="square-toggle-button2" [value]="campaignTypes?.EMAIL">
                            <span>
                                <img class="small-svg" src="assets/img/icons/email-primary.svg" alt="">
                              </span>
                          <br>EMAIL
                        </mat-button-toggle>
                      </div>
                      <div class="mat-button-toggle-center">
                        <mat-button-toggle class="square-toggle-button" [value]="campaignTypes?.SMS">
                            <span>
                              <img class="small-svg" src="assets/img/icons/sms-primary.svg" alt="">
                            </span>
                              <br>SMS
                        </mat-button-toggle>
                      </div>
                    </mat-button-toggle-group>
                    <div class="row py-4"></div>
                    <div class="mt-4 pull-right">
                      <button mat-button mat-raised-button color="primary" [disabled]="!shop_id?.valid" matStepperNext type="button">Next</button>
                    </div>
                  </mat-step>
                  <mat-step label="Audience">
                    <div class="row mt-4">
                      <mat-button-toggle-group style="border: none;" color="primary" formControlName="target_type">
                        <div class="row">
                          <div class="col-md-4 col-sm-6 mb-3">
                            <div class="mat-button-toggle-center">
                              <mat-button-toggle title="All Customers" color="primary" class="button-all-customers" [value]="targetTypes?.ALL">
                                <span>
                                  <img class="small-svg" src="assets/img/icons/customers-primary.svg" alt="">
                                </span> <br>
                                  All Customers
                              </mat-button-toggle>
                            </div>
                          </div>
                          <div class="col-md-4 col-sm-6 mb-4">
                            <div class="mat-button-toggle-center">
                              <mat-button-toggle title="Based on Date range" color="primary" class="square-toggle-btn" [value]="targetTypes?.CUSTOMER_DATE_RANGE_VISITS">
                                <span>
                                    <img class="small-svg" src="assets/img/icons/calendar-primary.svg" alt="">
                                  </span> <br>  
                                Date Range
                              </mat-button-toggle>
                            </div>
                          </div>
                          <div class="col-md-4 col-sm-6 mb-4">
                            <div class="mat-button-toggle-center">
                              <mat-button-toggle title="Total Number Customers visit Shop" color="primary" class="square-toggle-btn" [value]="targetTypes?.CUSTOMER_NUMBER_OF_VISITS">
                                <span>
                                    <img class="small-svg" src="assets/img/icons/customer-visit-primary.svg" alt="">
                                  </span> <br>   
                                No of Visits
                              </mat-button-toggle>
                            </div>
                          </div>
                          <div class="col-md-4 col-sm-6 mb-4">
                            <div class="mat-button-toggle-center">
                              <mat-button-toggle title="Perticular Customers" color="primary" class="button-specific-customers" [value]="targetTypes?.SPECIFIC_CUSTOMERS">
                                <span>
                                  <img class="small-svg" src="assets/img/icons/customer-specific-primary.svg" alt="">
                                </span> <br> 
                                Spec. Customers
                              </mat-button-toggle>
                            </div>
                          </div>
                          <div class="col-md-4 col-sm-6 mb-4">
                            <div class="mat-button-toggle-center">
                              <mat-button-toggle title="Specific Segments" color="primary" class="button-customers-segments" [value]="targetTypes?.CUSTOMER_GROUP">
                                <span>
                                  <img class="small-svg" src="assets/img/icons/customer-target-primary.svg" alt="">
                                </span> <br> 
                                  Spec. Segments
                              </mat-button-toggle>
                            </div>
                          </div>
                        </div>
                      </mat-button-toggle-group>
                    </div>
                    <div class="row">
                      <div class="col-12">
                        <div class="row" *ngIf="target_type?.value == targetTypes?.CUSTOMER_DATE_RANGE_VISITS">
                          <mat-form-field class="col-md-6">
                            <input type="text" matInput placeholder="Start Date" formControlName="visit_start_date"
                              [matDatepicker]="startDatePicker" (focus)="startDatePicker?.open()">
                            <mat-hint class="text-danger" *ngIf="!visit_start_date?.valid && visit_start_date?.touched">
                              Please enter Start Date</mat-hint>
                            <mat-datepicker #startDatePicker></mat-datepicker>
                          </mat-form-field>
                          <mat-form-field class="col-md-6">
                            <input type="text" matInput placeholder="End Date" formControlName="visit_end_date"
                              [matDatepicker]="endDatePicker" (focus)="endDatePicker?.open()">
                            <mat-hint class="text-danger" *ngIf="!visit_end_date?.valid && visit_end_date?.touched">Please enter End Date
                            </mat-hint>
                            <mat-datepicker #endDatePicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                        <div class="row" *ngIf="target_type?.value == targetTypes?.CUSTOMER_NUMBER_OF_VISITS">
                          <mat-form-field class="col-md-6">
                            <input type="text" matInput placeholder="Minimum Visits" formControlName="customer_number_of_visits_at_least"
                            NumberOnly>
                            <mat-hint class="text-danger"
                              *ngIf="!customer_number_of_visits_at_least?.valid && customer_number_of_visits_at_least?.touched">
                              Please enter Minimum Visits</mat-hint>
                            <mat-datepicker #startDatePicker></mat-datepicker>
                          </mat-form-field>
                          <mat-form-field class="col-md-6">
                            <input type="text" matInput placeholder="Maximum Visits" formControlName="customer_number_of_visits_at_most"
                            NumberOnly>
                            <mat-hint class="text-danger"
                              *ngIf="!customer_number_of_visits_at_most?.valid && customer_number_of_visits_at_most?.touched">Please enter
                              Maximum Visits</mat-hint>
                            <mat-datepicker #endDatePicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                        <div class="row" *ngIf="target_type?.value == targetTypes?.SPECIFIC_CUSTOMERS">
                          <div class="col-12 mt-3 ">
                            <app-multi-select-dropdown [placeholder]="'Select Cusomers'" [data]="dropdownList"
                              [settings]="dropdownSettings" formControlName="customer_ids" (onFilterChange)="onFilterChange($event)">
                            </app-multi-select-dropdown>
                          </div>
                        </div>
                        <div class="row" *ngIf="target_type?.value == targetTypes?.CUSTOMER_GROUP">
                          <div class="col-12 mt-3 ">
                            <app-multi-select-dropdown [placeholder]="'Select Cusomer Groups'" [data]="customerGroupDropdownList"
                              [settings]="dropdownSettings" formControlName="customer_group_ids"
                              (onFilterChange)="onFilterCucstomerGroup($event)"></app-multi-select-dropdown>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row py-4"></div>
                    <div class="mt-4 pt-3 pull-right">
                      <button mat-button mat-raised-button matStepperPrevious type="button">Back</button>
                      <button class="ml-2" mat-button mat-raised-button color="primary" matStepperNext type="button">Next</button>
                    </div>
                  </mat-step>
                  <mat-step label="Design">
                    <div>
                      <div class="row" *ngIf="campaign_type?.value === campaignTypes?.ALL || campaign_type?.value === campaignTypes?.EMAIL">
                        <mat-form-field class="col-md-12 mb-3">
                          <input type="text" matInput placeholder="Title" formControlName="title" alphaNumericOnly>
                          <mat-hint class="text-danger">
                            <div *ngIf="!title?.valid && title?.touched">Please enter Campaign Title</div>
                          </mat-hint>
                        </mat-form-field>
                      </div>
                      <div class="row">
                        <mat-form-field class="col-md-12 mb-3">
                          <textarea matInput placeholder="Message" formControlName="content" style="min-height: 80px;" alphaNumericOnly></textarea>
                          <mat-hint class="text-danger">
                         <div *ngIf="!content?.valid && content?.touched">Please enter Campaign Message</div>
                          <!-- <div *ngIf="campaign_type?.value === campaignTypes?.SMS">
                            <span *ngIf="!content.valid && content?.touched && content?.maxLength">SMS Message can not exceed 160 characters</span>
                          </div> -->
                        </mat-hint>
                          <!-- <mat-hint *ngIf="campaign_type?.value === campaignTypes?.SMS" align="end">{{content.value.length}} / 160</mat-hint> -->
                        </mat-form-field>
                      </div>
                      <div class="row">
                        <div *ngIf="campaign_type?.value === campaignTypes?.ALL || campaign_type?.value === campaignTypes?.EMAIL" class="col-md-12 mb-4">
                          <app-file-upload-control formControlName="image" (change)="previewCampaignImage($event)"></app-file-upload-control>
                          <mat-hint class="text-danger" *ngIf="!image?.valid && image?.touched">Please enter Campaign Image
                          </mat-hint>
                        </div>
                      </div>
                      <div class="row mt-3">
                        <div class="col-md-6  mb-2">
                          <label>Publishing Time</label><br>
                          <mat-button-toggle-group color="primary" class="mat-toggle-buttons-adjustment"
                            formControlName="is_scheduled">
                            <mat-button-toggle color="primary" [value]="false"><b>NOW</b></mat-button-toggle>
                            <mat-button-toggle color="primary" [value]="true"><b>LATER</b></mat-button-toggle>
                          </mat-button-toggle-group>
                        </div>
                        <mat-form-field class="col-md-6 mt-2" *ngIf="is_scheduled.value === true">
                          <input matInput placeholder="Schedule Date/Time" formControlName="scheduled_time"
                            [ngxMatDatetimePicker]="scheduledDatePicker" (focus)="scheduledDatePicker?.open()">
                          <mat-hint class="text-danger" *ngIf="!scheduled_time?.valid && scheduled_time?.touched">Please enter Message Date</mat-hint>
                          <ngx-mat-datetime-picker #scheduledDatePicker [showSeconds]="true"></ngx-mat-datetime-picker>
                        </mat-form-field>
                      </div>
                      <div class="row py-3"></div>
                      <div class="mt-4 pull-right">
                        <button mat-button mat-raised-button matStepperPrevious type="button">Back</button>
                        <button class="ml-2" mat-button mat-raised-button color="primary" [disabled]="!content?.valid" matStepperNext type="button">Next</button>
                      </div>
                    </div>
                  </mat-step>
                  <mat-step label="Campaign Preview">

                    <div class="row mt-3" *ngIf="campaign_type?.value === campaignTypes?.ALL">
                      <div class="col-xl-6 col-lg-6 col-12 mb-4 ">
                        <h3 class="font-weight-600 pl-4 pb-3">Email Campaign</h3>
                        <div style="max-width: 260px;">
                          <div class="campaign-bg-iphone" >
                            <div class="account-image" style="left: 24px;">
                              <span>{{getBusinessName() | uppercase | slice: 0:1}}</span>
                            </div
                            ><span class="px-70">
                              <tr class="fs-11 font-weight-600">{{getBusinessName()}}</tr>
                              <tr class="fs-11 font-weight-600">me</tr>
                            </span>
                            <br>
                            <div class="mx-4 pr-1 text-left" style="max-height: 350px; overflow-y: overlay; overflow-x: hidden;">
                              <h4 class="text-center fs-12 my-2"><b>{{title.value}}</b></h4>
                              <span class="fs-11">
                                <div class="fs-12"><b>Hello,</b></div>
                                <div class="my-2">
                                  <img [src]="imageSource" class="wh-200" *ngIf="imageSource">
                                </div>
                                {{content.value}}
                              </span>
                              <br> <br>
                              <span class="fs-12">
                                <p class="mb-0 fs-12">Regards,</p>
                                <b>{{getBusinessName()}}</b>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-xl-6 col-lg-6 col-12 mb-4" >
                        <h3 class="font-weight-600 pl-4 pb-3">SMS Campaign</h3>
                        <div class="text-center" style="max-width: 260px;">
                          <div class="campaign-bg-iphone">
                            <div class="account-image text-center">
                              <span>{{getBusinessName() | uppercase | slice: 0:1}}</span>
                            </div>
                            <br>
                            <h5 class="mt-3 fs-11 font-weight-600">{{getBusinessName()}}<i class="fe fe-chevron-right"></i></h5>
                            <div class="mx-4 pr-1 text-left" style="max-height: 350px; overflow-y: overlay; overflow-x: hidden;">
                              <span class="fs-11">
                                <b>Hello, </b>{{content.value}}
                              </span>
                              <!-- <br> <br>
                              <span class="fs-12 mt-2">
                                <p class="mb-0 fs-12">Regards,</p>
                                <b>KudiGo </b>
                              </span> -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row mt-3">
                      <div class="col-xl-6 col-lg-6 col-12 offset-md-3 mb-4" *ngIf="campaign_type?.value === campaignTypes?.EMAIL">
                        <h3 class="font-weight-600 pl-4 pb-3">Email Campaign</h3>
                        <div style="max-width: 260px;">
                          <div class="campaign-bg-iphone" >
                            <div class="account-image" style="left: 24px;">
                              <span>{{getBusinessName() | uppercase | slice: 0:1}}</span>
                            </div
                            ><span class="px-70">
                              <tr class="fs-11 font-weight-600">{{getBusinessName()}}</tr>
                              <tr class="fs-11 font-weight-600">me</tr>
                            </span>
                            <br>
                            <div class="mx-4 pr-1 text-left" style="max-height: 350px; overflow-y: overlay; overflow-x: hidden;">
                              <h4 class="text-center fs-12 my-2"><b>{{title.value}}</b></h4>
                              <span class="fs-11">
                                <div class="fs-12"><b>Hello,</b></div>
                                <div class="my-2">
                                  <img [src]="imageSource" class="wh-200" *ngIf="imageSource">
                                </div>
                                {{content.value}}
                              </span>
                              <br> <br>
                              <span class="fs-12">
                                <p class="mb-0 fs-12">Regards,</p>
                                <b>{{getBusinessName()}}</b>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-xl-6 col-lg-6 col-12 offset-md-3 mb-4" *ngIf="campaign_type?.value === campaignTypes?.SMS">
                        <h3 class="font-weight-600 pl-4 pb-3">SMS Campaign</h3>
                        <div class="text-center" style="max-width: 260px;">
                          <div class="campaign-bg-iphone">
                            <div class="account-image text-center">
                              <span>{{getBusinessName() | uppercase | slice: 0:1}}</span>
                            </div>
                            <br>
                            <h5 class="mt-3 fs-11 font-weight-600">{{getBusinessName()}}<i class="fe fe-chevron-right"></i></h5>
                            <div class="mx-4 pr-1 text-left" style="max-height: 350px; overflow-y: overlay; overflow-x: hidden;">
                              <span class="fs-11">
                                <b>Hello, </b>{{content.value}}
                              </span>
                              <br> <br>
                              <!-- <span class="fs-12 mt-2">
                                <p class="mb-0 fs-12">Regards,</p>
                                <b>KudiGo </b>
                              </span> -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="row mt-2">
                      <div class="col-xl-3 col-lg-3 col-md-6">
                        <div class="campaign-box">
                          <div class="campaign-box-body text-center">
                            <h5>Publishing Time</h5>
                            <span class="text-primary font-weight-600">
                              <span *ngIf="is_scheduled.value === false">NOW</span>
                              <span *ngIf="is_scheduled.value === true">LATER</span>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="col-xl-3 col-lg-3 col-md-6">
                        <div class="campaign-box">
                          <div class="campaign-box-body text-center">
                            <h5>Campaign Type</h5>
                            <span class="text-primary font-weight-600">
                              <span *ngIf="campaign_type.value === campaignTypes?.ALL">Email & SMS</span>
                                <span *ngIf="campaign_type.value === campaignTypes?.EMAIL">Email</span>
                                <span *ngIf="campaign_type.value === campaignTypes?.SMS">SMS</span>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="col-xl-3 col-lg-3 col-md-6">
                        <div class="campaign-box">
                          <div class="campaign-box-body text-center">
                            <h5>Audience</h5>
                            <span class="text-primary font-weight-600">
                              <span *ngIf="target_type?.value == targetTypes?.CUSTOMER_GROUP">Customers Segments</span>
                              <span *ngIf="target_type?.value == targetTypes?.CUSTOMER_DATE_RANGE_VISITS">Date Visit Ranges</span>
                              <span *ngIf="target_type?.value == targetTypes?.SPECIFIC_CUSTOMERS">Specific Customers</span>
                              <span *ngIf="target_type?.value == targetTypes?.CUSTOMER_NUMBER_OF_VISITS">Customer Visits</span>
                              <span *ngIf="target_type?.value == targetTypes?.ALL">All Customers</span>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="col-xl-3 col-lg-3 col-md-6">
                        <div class="campaign-box">
                          <div class="campaign-box-body text-center">
                            <h5>SMS Credit</h5>
                            <span>
                              <span class="font-weight-800">
                                <span *ngIf="smsRemaining === 0" class="text-danger">{{smsRemaining}}</span>
                                <span *ngIf="smsRemaining >= 1" class="text-primary">{{smsRemaining}}</span>
                              </span>
                              <span class="mr-2">
                                <a class="text-primary fs-11 ml-2 cursor-pointer" (click)="onSMStopUp()"><b>Top Up</b></a>
                              </span>

                            </span>
                          </div>
                        </div>
                      </div>
                      
                    </div>

                    <div class="row pt-3 mb-4"></div>
                    <div class="pull-right">
                      <button mat-button mat-raised-button matStepperPrevious color="warn" (click)="stepper.reset()">Reset</button>
                      <button mat-button mat-raised-button matStepperPrevious type="button" class="mx-2">Back</button>
                      <button mat-raised-button color="primary" [disabled]="!formGroup?.valid || isProcessing || campaign_type?.value === campaignTypes?.SMS && smsRemaining === 0 || campaign_type?.value === campaignTypes?.ALL  && smsRemaining === 0" type="submit">
                        <mat-progress-bar class="mb-0" *ngIf="isProcessing" mode="indeterminate"> </mat-progress-bar>
                        <span *ngIf="campaign_type?.value === campaignTypes?.SMS && smsRemaining === 0 || campaign_type?.value === campaignTypes?.ALL && smsRemaining === 0"> <i class="fe fe-info fs-1 vertical-align-middle" ngbPopover="You can not publish campaign with Zero SMS credit." placement="top" triggers="mouseenter:mouseleave" popoverTitle="Low SMS Credit"></i></span> 
                        Publish Campaign 
                      </button>
                    </div>
                  </mat-step>
                </mat-horizontal-stepper>
              </form>
        </div>
      </div>
  </div>

</app-main-nav>